#!/bin/bash
# Combined pre-commit hook: Markdown checks + auto-documentation
# Install: ln -s ../../scripts/pre-commit-combined .git/hooks/pre-commit

set -e

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "üîç Pre-commit checks..."

# ============================================================
# PART 1: Auto-generate tool documentation (if handlers changed)
# ============================================================
if git diff --cached --name-only | grep -q 'src/mcp_handlers/.*\.py'; then
    echo "üìù Handler files changed, regenerating documentation..."
    python3 scripts/generate_tool_docs.py
    # Add generated docs to commit
    git add tools/README.md
    echo "‚úÖ Documentation updated and staged"
fi

# ============================================================
# PART 2: Markdown proliferation check
# ============================================================
NEW_MARKDOWN_FILES=$(git diff --cached --name-only --diff-filter=A | grep '\.md$' || true)

if [ -n "$NEW_MARKDOWN_FILES" ]; then
    echo ""
    echo "üìÑ Checking new markdown files..."
    
    VIOLATIONS=0
    
    for file in $NEW_MARKDOWN_FILES; do
        # Skip approved files
        if [[ "$file" == "README.md" ]] || \
           [[ "$file" == "CHANGELOG.md" ]] || \
           [[ "$file" == "START_HERE.md" ]] || \
           [[ "$file" == "docs/README.md" ]] || \
           [[ "$file" == "docs/QUICK_REFERENCE.md" ]] || \
           [[ "$file" == "docs/DOC_MAP.md" ]] || \
           [[ "$file" == docs/meta/MARKDOWN_*.md ]] || \
           [[ "$file" == docs/guides/*.md ]] || \
           [[ "$file" == docs/architecture/*.md ]] || \
           [[ "$file" == "tools/README.md" ]]; then  # Auto-generated docs are OK
            echo "  ‚úÖ $file - Approved"
            continue
        fi
        
        # Check file size
        if [ -f "$file" ]; then
            WORD_COUNT=$(wc -w < "$file" 2>/dev/null || echo "0")
            
            if [ "$WORD_COUNT" -lt 500 ]; then
                echo "  ‚ùå $file - Too small ($WORD_COUNT words, need 500+)"
                echo "     ‚Üí Consider consolidating into existing doc or using store_knowledge()"
                VIOLATIONS=$((VIOLATIONS + 1))
            elif [ "$WORD_COUNT" -lt 1000 ]; then
                echo "  ‚ö†Ô∏è  $file - Small ($WORD_COUNT words, recommend 1000+)"
                echo "     ‚Üí Consider consolidating into existing doc"
            else
                echo "  ‚úÖ $file - Size OK ($WORD_COUNT words)"
            fi
        fi
    done
    
    if [ $VIOLATIONS -gt 0 ]; then
        echo ""
        echo "‚ùå Markdown proliferation policy violation!"
        echo "   See: docs/meta/MARKDOWN_PROLIFERATION_POLICY.md"
        echo ""
        echo "   Options:"
        echo "   1. Consolidate into existing doc"
        echo "   2. Use store_knowledge() for insights/discoveries"
        echo "   3. Archive if historical"
        echo "   4. Skip check: git commit --no-verify (not recommended)"
        exit 1
    fi
fi

# ============================================================
# PART 3: Validate markdown formatting
# ============================================================
if command -v python3 &> /dev/null; then
    if [ -f "$PROJECT_ROOT/scripts/validate_markdown_formatting.py" ]; then
        echo ""
        echo "üìù Validating markdown formatting..."
        python3 "$PROJECT_ROOT/scripts/validate_markdown_formatting.py" || {
            echo ""
            echo "‚ö†Ô∏è  Markdown formatting issues found"
            echo "   Run: python3 scripts/validate_markdown_formatting.py --fix"
            echo "   Or: git commit --no-verify (not recommended)"
            # Don't fail commit for formatting issues (warn only)
        }
    fi
fi

echo ""
echo "‚úÖ Pre-commit checks passed"

